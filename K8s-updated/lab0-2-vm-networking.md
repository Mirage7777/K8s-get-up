# 实验0.2：虚拟机网络和快照管理

## 目标
配置虚拟机之间的网络通信，以及使用快照管理虚拟机状态。

## 准备工作
- 已完成实验0.1
- 基本的网络知识

## 步骤

### 1. 创建多个不同网络配置的虚拟机

我们将创建三个不同网络模式的虚拟机，理解它们之间的差异。

#### VM1: NAT网络
1. 复制实验0.1中创建的虚拟机（通过克隆）：
   - 在VMware Workstation中，右键点击已有的虚拟机
   - 选择"管理" -> "克隆"
   - 名称：VM1-NAT
   - 选择"创建完整克隆"
   - 保持网络设置为NAT

#### VM2: 桥接网络
1. 再次克隆实验0.1中的虚拟机：
   - 名称：VM2-Bridged
   - 选择"创建完整克隆"
2. 修改网络设置：
   - 选择VM2-Bridged，点击"编辑虚拟机设置"
   - 选择"网络适配器"
   - 将"网络连接"改为"桥接模式"
   - 选择"自动检测"或选择特定的物理网卡

#### VM3: 仅主机网络
1. 再次克隆虚拟机：
   - 名称：VM3-HostOnly
   - 选择"创建完整克隆"
2. 配置主机网络：
   - 在VMware Workstation菜单，选择"编辑" -> "虚拟网络编辑器"
   - 确保至少有一个主机专用网络（通常是VMnet1）
   - 记下该网络的IP地址范围
3. 修改VM3网络设置：
   - 选择VM3-HostOnly，点击"编辑虚拟机设置"
   - 选择"网络适配器"
   - 将"网络连接"改为"仅主机模式"（Host-only）
   - 选择VMnet1或其他主机专用网络

### 2. 启动并配置虚拟机

对每个虚拟机进行以下操作：

1. 启动虚拟机
2. 登录系统
3. 获取网络信息：
   ```bash
   # 获取IP地址
   ip addr show
   
   # 查看网络配置
   cat /etc/netplan/00-installer-config.yaml
   
   # 测试互联网连接
   ping -c 4 8.8.8.8
   ```
4. 记录每个虚拟机的IP地址

### 3. 测试虚拟机之间的连接

1. 在每个虚拟机上安装必要工具：
   ```bash
   sudo apt update
   sudo apt install -y net-tools
   ```

2. 从每个虚拟机尝试ping其他虚拟机：
   ```bash
   ping -c 4 <VM1-IP>
   ping -c 4 <VM2-IP>
   ping -c 4 <VM3-IP>
   ```

3. 填写连通性表格，记录哪些虚拟机之间可以互相访问：

| 来源/目标    | VM1 (NAT) | VM2 (桥接) | VM3 (仅主机) | 宿主机 | 互联网 |
| ------------ | --------- | ---------- | ------------ | ------ | ------ |
| VM1 (NAT)    |           |            |              |        |        |
| VM2 (桥接)   |           |            |              |        |        |
| VM3 (仅主机) |           |            |              |        |        |
| 宿主机       |           |            |              | -      |        |

### 4. 使用快照管理虚拟机状态

我们将使用VM1（NAT）进行快照练习：

1. 在VM1上创建一些文件来代表"重要工作"：
   ```bash
   mkdir -p ~/important-work
   echo "这是重要文件" > ~/important-work/file1.txt
   echo "这也是重要文件" > ~/important-work/file2.txt
   ```

2. 创建快照：
   - 在VMware Workstation中选择VM1
   - 点击"虚拟机" -> "快照" -> "拍摄快照"
   - 命名为"重要工作完成"，添加描述
   - 点击"拍摄快照"

3. 模拟系统损坏：
   ```bash
   # 删除重要文件
   rm -rf ~/important-work
   
   # 验证文件已删除
   ls ~/important-work
   ```

4. 恢复到快照：
   - 在VMware Workstation中，选择"虚拟机" -> "快照" -> "快照管理器"
   - 在快照管理器中选择"重要工作完成"快照
   - 点击"转到"按钮
   - 选择"是"确认恢复

5. 验证文件是否已恢复：
   ```bash
   ls ~/important-work
   cat ~/important-work/file1.txt
   ```

### 5. VMware网络高级功能

1. 使用VMware网络工具检查网络配置：
   - 在VMware Workstation菜单，选择"编辑" -> "虚拟网络编辑器"
   - 记录各个虚拟网络的设置（NAT、桥接、仅主机）
   - 观察DHCP设置和IP地址范围

2. 如果需要修改VM1的MAC地址：
   - 关闭VM1
   - 在虚拟机设置中，选择"网络适配器" -> "高级"
   - 配置MAC地址（可以生成随机地址或手动指定）

## 思考问题

1. 不同网络模式（NAT、桥接、仅主机网络）各有什么优势和局限性？
2. 什么情况下你会选择每种网络模式？
3. 快照的技术实现原理是什么？它与不可变基础设施（Immutable Infrastructure）的概念有什么关系？
4. 为什么生产环境中很少使用虚拟机快照作为长期备份解决方案？
5. VMware Workstation的虚拟网络编辑器提供了哪些网络功能？这些功能如何帮助构建复杂的网络环境？

## 扩展练习

1. 在VM2（桥接网络）上设置一个简单的Web服务器：
   ```bash
   sudo apt install -y apache2
   echo "<h1>来自桥接网络虚拟机的问候</h1>" | sudo tee /var/www/html/index.html
   ```
   然后从宿主机的浏览器访问 http://<VM2-IP>

2. 创建快照树：
   - 在VM1上创建初始快照
   - 做一些更改后，创建第二个快照
   - 恢复到初始快照
   - 做一些不同的更改，创建第三个快照
   - 在VMware的快照管理器中观察快照树结构
   - 尝试在不同快照之间切换

3. 使用VMware Workstation的网络适配器混杂模式，配置一个能够抓包的环境，分析虚拟机之间的网络流量 